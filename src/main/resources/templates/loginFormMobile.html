<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="layouts/XRegister/head :: headFragment" />

<!-- ===============================================-->
<!--    Favicons   th:src="@{/assets/img/team/25.jpg}"    -->  
<!-- ===============================================-->
<link rel="apple-touch-icon" sizes="180x180" th:href="@{/assetsfalcon/img/favicons/apple-touch-icon.png}">
<link rel="icon" type="image/png" sizes="32x32" th:href="@{/assetsfalcon/img/favicons/favicon-32x32.png}">
<link rel="icon" type="image/png" sizes="16x16" th:href="@{/assetsfalcon/img/favicons/favicon-16x16.png}">
<link rel="shortcut icon" type="image/x-icon" th:href="@{/assetsfalcon/img/favicons/favicon.ico}">
<link rel="manifest" th:href="@{/assetsfalcon/img/favicons/manifest.json}">
<meta name="msapplication-TileImage" content="@{/assetsfalcon/img/favicons/mstile-150x150.png}">
<meta name="theme-color" content="#ffffff">
<script th:src="@{/assetsfalcon/js/config.js}"></script>
<script th:src="@{/vendors/overlayscrollbars/OverlayScrollbars.min.js}"></script>


<!-- ===============================================-->
<!--    Stylesheets-->
<!-- ===============================================-->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700%7cPoppins:300,400,500,600,700,800,900&amp;display=swap" rel="stylesheet">
<link th:href="@{/vendors/overlayscrollbars/OverlayScrollbars.min.css}" rel="stylesheet">
<link th:href="@{/assetsfalcon/css/theme-rtl.min.css}" rel="stylesheet" id="style-rtl">
<link th:href="@{/assetsfalcon/css/theme.min.css}" rel="stylesheet" id="style-default">
<link th:href="@{/assetsfalcon/css/user-rtl.min.css}" rel="stylesheet" id="user-style-rtl">
<link th:href="@{/assetsfalcon/css/user.min.css}" rel="stylesheet" id="user-style-default">
<body>
  <!-- ===============================================-->
  <!--    Main Content-->
  <!-- ===============================================--> 
  <main class="main" id="top">
    <div class="container-fluid">
      <div class="row min-vh-100 flex-center g-0">
        <div class="col-lg-8 col-xxl-5 py-3 position-relative">
          <img class="bg-auth-circle-shape" th:src="@{/assets/img/icons/spot-illustrations/bg-shape.png}" alt=""
            width="250">
          <img class="bg-auth-circle-shape-2" th:src="@{/assets/img/icons/spot-illustrations/shape-1.png}" alt=""
            width="150">
          <div class="card overflow-hidden z-index-1">
            <div class="card-body p-0">
              <div class="row g-0 h-100">
                <div class="col-md-5 text-center bg-card-gradient">
                  <div class="position-relative p-4 pt-md-5 pb-md-7 light">
                    <div class="bg-holder bg-auth-card-shape"
                      style="background-image:url(../../../assets/img/icons/spot-illustrations/half-circle.png);">
                    </div>
                    <!--/.bg-holder-->

                    <div class="z-index-1 position-relative"><a
                        class="link-light mb-4 font-sans-serif fs-4 d-inline-block fw-bolder" href="http://www.c-kd.com/">경덕산업
                        MES</a>
                        <!-- <img   th:src="@{/assets/img/logos/kyoungduk_img01.jpg}" alt=""   > -->
                      <p class="opacity-75 text-white">With the power of KyoungDuk, you can now focus only on functionaries
                        for your digital source, while leaving the data service on us!</p>
                    </div>
                  </div>
                  <!-- <div class="mt-3 mb-4 mt-md-4 mb-md-5 light">
                    <p class="text-white">계정이 없으신가요?<br><a class="text-decoration-underline link-light"
                        th:href="@{/members/new}">사용자등록</a></p>
                    <p class="mb-0 mt-4 mt-md-5 fs--1 fw-semi-bold text-white opacity-75">Read our <a
                        class="text-decoration-underline text-white" href="#!">terms</a> and <a
                        class="text-decoration-underline text-white" href="#!">conditions </a></p>
                  </div> -->
                </div>
                <div class="col-md-4 d-flex flex-center">
                  <div class="p-4 p-md-5 flex-grow-1">
                    <div class="row flex-between-center">
                      <div class="col-auto">
                        <!-- <h3>Login</h3> -->
                        <img   th:src="@{/assets/img/logos/logo.png}" alt="" width="200"   > 
                      </div>
                    </div>
                    <form  action="/login" method="POST">
                      <!-- <div class="input_wrap"> 
                        <select name="select" id="select" class="select">
                          <option value="AA">본사</option>
                          <option value="BB">공장</option>  
                        </select> 
                      </div>  -->
                      <div class="mb-3">
                        <label class="form-label" for="card-email">User ID</label>
                        <input class="form-control" name="loginid" id="loginid" type="text" />
                        <input type="hidden" id="ipaddr" name="ipaddr">
                        <input type="hidden" id="select" name="select"> 
                      </div>
                      <div class="mb-3">
                        <div class="d-flex justify-content-between">
                          <label class="form-label" for="card-password">Password</label>
                        </div>
                        <input class="form-control" name="logpass" id="logpass" type="password" />
                      </div>
                      <!-- <div class="row flex-between-center">
                        <div class="col-auto">
                          <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="card-checkbox" checked="checked" />
                            <label class="form-check-label mb-0" for="card-checkbox">Remember me</label>
                          </div>
                        </div>
                      </div> -->
                      <div class="mb-3">
                        <!-- <button class="btn btn-primary d-block w-100 mt-3" type="submit" name="submit">Log in</button> -->
                          <button class="btn btn-primary d-block w-100 mt-3" type="button" id="login_btn" name="login_btn">Log in</button>
                      </div>
                      <div class="mb-3">
                        <div th:if="${loginErrorMsg}" class="alert alert-warning border-2 d-flex align-items-center"
                          role="alert">
                          <div class="bg-warning me-3 icon-item"><span
                              class="fas fa-exclamation-circle text-white fs-3"></span></div>
                          <p class="mb-0 flex-1" th:text="${loginErrorMsg}">Incorrent data</p>
                        </div>
                      </div>
                       <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"></input> -->
                    </form>
                    <!-- <div th:if="${param.error}">
                                <div class="alert alert-danger" role="alert">
                                    <b>사용자 아이디 또는 암호를 확인하세요.</b>
                                </div>
                            </div>
                            <div th:if="${param.logout}">
                                <div class="alert alert-danger" role="alert">
                                    <b>로그아웃 되었습니다.</b>
                                </div>        
                            </div>                               -->
                    <!-- <div class="position-relative mt-4">
                              <hr class="bg-300" />
                              <div class="divider-content-center">or log in with</div>
                            </div> -->
                    <!-- <div class="row g-2 mt-2">
                              <div class="col-sm-6"><a class="btn btn-outline-google-plus btn-sm d-block w-100" href="#"><span class="fab fa-google-plus-g me-2" data-fa-transform="grow-8"></span> google</a></div>
                              <div class="col-sm-6"><a class="btn btn-outline-facebook btn-sm d-block w-100" href="#"><span class="fab fa-facebook-square me-2" data-fa-transform="grow-8"></span> facebook</a></div>
                            </div> -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>




    <script>

      window.onload = function() {  
        getIpClient();
      }

      async function getIpClient() {
        try {
          const response = await axios.get('https://api.ipify.org?format=json');
          document.getElementById('ipaddr').value = response.data.ip;
          // console.log(response.data.ip);
          // console.log("----");
        } catch (error) {
          console.error(error);
        }
      }

        


      var btn_obj = document.getElementById('login_btn');
      btn_obj.addEventListener("click",function(){
        
          //TB_FPLAN_WORK TB_FPLAN_W010  SAVE
          var ls_loginid   = document.getElementById('loginid').value;
          var ls_logpass   = document.getElementById('logpass').value;
          var ls_ipaddr    = document.getElementById('ipaddr').value;
          var ls_select  = document.getElementById('select').value;
          ls_select = "AA";
          var ls_actcustcdz = "KDMES" ; //document.getElementById('actcustcdz').value;
          $.ajax({
              url: '/authcrud/login',
              type:"POST",
              data: {
                  "loginid"    : ls_loginid ,
                  "logpass"  : ls_logpass,
                  "ipaddr"  : ls_ipaddr,
                  "flag"    : ls_select 
              },
              async:false,
              success:function(userFormDto){

                var ListDto = userFormDto;
                var ls_userid = userFormDto["userid"]
                var ls_username = userFormDto["username"]
                var ls_cltcd= userFormDto["cltcd"]
                var ls_dbnm = userFormDto["dbnm"]
                var ls_flag = userFormDto["flag"]
                //var ls_url = 'userid=' + ls_userid +'&username=' + ls_username +'&cltcd=' + ls_cltcd +'&dbnm=' + ls_dbnm +'&flag=' + ls_flag;
                var ls_url = 'userid=' + ls_userid
                var ls_useyn = userFormDto["useyn"]
                var ls_wrongnum = userFormDto["wrongnum"] 
                window.localStorage.setItem("perid",  userFormDto["perid"])
                window.localStorage.setItem("pernm",  userFormDto["pernm"])
                window.localStorage.setItem("custnm",  userFormDto["custnm"])
                if(userFormDto == "" || userFormDto == null){
                  alert("사용자 구분을 확인하세요.");
                  return false;
                }

                if(ls_wrongnum == 3 || ls_useyn == "N"){
                  wrongPasswd();
                }else{
                  insertLogin();
                  window.location.href = '/appm/mainframemb';
                  // if(ls_select == "CC"){
                  //   window.location.href = '/appm/index140m';
                  // }else{
                  //   window.location.href = '/app01/index150m'; 
                  // }
                    // if(data == "success"){
                  //     alert("등록 되었습니다.");
                  //     var ls_text = "<div style='color:red'><span class='badge badge-soft-danger'>가입되었습니다.</span></div>";
                  // }else{
                  //     alert("등록오류");
                  //     var ls_text = "<div style='color:red'><span class='badge badge-soft-info'>가입실패</span></div>";
                  // }
                  // statusdis_div.innerHTML  = ls_text;
                }

              },error:function(e){
                  wrongPasswd();
              }
          }).done(function(fragment){

          })

     })

     function insertLogin(){
      console.log("insertlogin start");
      var ls_loginid   = document.getElementById('loginid').value;
      var ls_logpass   = document.getElementById('logpass').value;
      var ls_ipaddr    = document.getElementById('ipaddr').value;
      console.log(ls_loginid, ls_logpass, ls_ipaddr);

      $.ajax({
        url: '/authcrud/loginlog',
        type:"POST",
        data: {
              "loginid" : ls_loginid,
              "logpass" : ls_logpass,
              "ipaddr"  : ls_ipaddr
        },
        async:false,
        success:function(){
          console.log('success');
        }
      });
     }

     function wrongPasswd(){
        console.log("wrongPasswd start");
        var ls_loginid   = document.getElementById('loginid').value;
        var ls_logpass   = document.getElementById('logpass').value;

        $.ajax({
        url: '/authcrud/wrongpasswd',
        type:"POST",
        data: {
              "loginid" : ls_loginid,
              "logpass" : ls_logpass
        },
        async:false,
        success:function(userFormDto){
          var ListDto = userFormDto;
          var ls_wrongnum = userFormDto["wrongnum"];
          var ls_useyn = userFormDto["useyn"];

          if(ls_wrongnum < 3 && ls_useyn == "Y"){
            alert("비밀번호를 "+ls_wrongnum+"회 틀렸습니다. 로그인 3회 실패 시 사용 중지됩니다.");
          }else{
            if(userFormDto == "null"){
              alert("등록되지 않은 사용자입니다.")
            }else {
              alert("사용 중지된 계정입니다. 관리자에게 문의하세요.");
              console.log(userFormDto);
            }
          }
        }
      });
     }



</script>
  </main>
  <!-- ===============================================-->
  <!--    End of Main Content-->
  <!-- ===============================================-->
  <footer th:replace="layouts/XRegister/footer :: footerFragment"></footer> 
</body>

</html>